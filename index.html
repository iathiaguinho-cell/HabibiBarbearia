<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Habibi Barbearia</title>
  
  <!-- Importação do Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

  <!-- Estilos Inline -->
  <style>
    /* =============== FONTES E ESTILOS GERAIS =============== */
    body { 
      font-family: 'Roboto', sans-serif; 
      background-color: #fdfaf6; /* Um branco mais quente */
      overflow-x: hidden;
    }
    .font-serif {
      font-family: 'Playfair Display', serif;
    }
    .shadow-top {
        box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
    }

    /* =============== LAYOUT DO KANBAN RESPONSIVO =============== */
    .kanban-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
    }
    @media (max-width: 1024px) {
        .kanban-container {
            display: flex;
            overflow-x: auto;
            padding-bottom: 1rem; /* Espaço para a barra de rolagem */
            scroll-snap-type: x mandatory; /* Efeito de "parada" nas colunas */
        }
    }
    .status-column { 
      background: #f3f4f6; /* Cinza claro */
      border-radius: 12px; 
      display: flex; 
      flex-direction: column; 
      min-height: 100px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      @media (max-width: 1024px) {
        flex: 0 0 300px; /* Não encolhe, não cresce, base de 300px */
        scroll-snap-align: start;
      }
    }
    .client-list { /* Nome da classe atualizado para clareza */
      flex-grow: 1; 
      overflow-y: auto; /* Permite scroll vertical se a lista for longa */
      padding: 0 8px 8px 8px;
    }
    .vehicle-card { /* O nome da classe foi mantido para compatibilidade, mas o conteúdo é de clientes */
      background: white; 
      border-radius: 8px; 
      padding: 12px; 
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: all 0.2s ease-in-out; 
      border-left: 5px solid;
      cursor: pointer;
      position: relative;
    }
    .vehicle-card:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 8px 12px rgba(0,0,0,0.1); 
      z-index: 10;
    }

    /* CORES POR STATUS DA BARBEARIA */
    .vehicle-card.status-Aguardando { border-left-color: #f59e0b; } /* Ambar */
    .vehicle-card.status-Em-Atendimento { border-left-color: #3b82f6; } /* Azul */
    .vehicle-card.status-Aguardando-Pagamento { border-left-color: #10b981; } /* Verde */
    .vehicle-card.status-Finalizado { border-left-color: #6b7280; opacity: 0.9; } /* Cinza */

    /* =============== MODAIS =============== */
    .modal { 
      background: rgba(0, 0, 0, 0.6); 
      backdrop-filter: blur(5px); 
      z-index: 50;
    }
    .modal-content { 
      background: #f8fafc; 
      border-radius: 16px; 
      max-height: 90vh; 
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 1.5rem;
      position: relative;
      flex-shrink: 0;
    }
    .modal-body {
      overflow-y: auto;
      flex-grow: 1;
      padding: 1.5rem;
    }
    .modal-footer {
      background: white;
      border-top: 1px solid #e2e8f0;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    /* =============== BOTÕES =============== */
    .btn { 
      transition: all 0.2s ease; 
      border-radius: 8px; 
      font-weight: 600; 
      padding: 0.5rem 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* =============== TIMELINE =============== */
    .timeline { 
      border-left: 3px solid #e5e7eb; 
      position: relative;
    }
    .timeline-item { 
      position: relative; 
      padding-left: 2.5rem; 
      margin-bottom: 1.5rem;
    }
    .timeline-icon {
      position: absolute; 
      left: -0.875rem;
      top: 0.25rem;
      width: 1.75rem; 
      height: 1.75rem;
      border-radius: 9999px; 
      background-color: white; 
      border: 3px solid;
      display: flex; 
      align-items: center; 
      justify-content: center;
      z-index: 10;
    }
    .timeline-item-log .timeline-icon { border-color: #3b82f6; color: #3b82f6; }
    .timeline-item-status .timeline-icon { border-color: #10b981; color: #10b981; }

    /* =============== NOTIFICAÇÕES =============== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 9999;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      max-width: 300px;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.success {
      background-color: #10b981;
    }
    .notification.error {
      background-color: #ef4444;
    }

    /* =============== SEÇÕES DO MODAL DE DETALHES =============== */
    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    /* Estilos para Impressão */
    @media print {
        .no-print {
            display: none !important;
        }
        .modal-body {
            overflow: visible;
        }
        .modal-content {
            box-shadow: none;
            border: 1px solid #ccc;
        }
    }
  </style>
</head>
<body class="bg-stone-100">
  <!-- TELA DE LOGIN POR USUÁRIO -->
  <div id="userScreen" class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
      <h1 class="text-4xl font-bold text-stone-800 font-serif">Habibi Barbearia</h1>
      <p class="text-gray-500 my-8">Selecione seu perfil para iniciar</p>
      <div id="userList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app" class="hidden flex flex-col min-h-screen">
    <header class="bg-white shadow-md sticky top-0 z-40">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center flex-wrap gap-y-2">
        <div class="flex items-center gap-3">
            <div>
                <h1 class="text-2xl font-bold text-stone-800 font-serif">Habibi Barbearia</h1>
            </div>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
          <button id="configBtn" class="btn bg-stone-600 hover:bg-stone-700 text-white px-3 py-2 sm:px-4 flex items-center gap-2 hidden">
            <i class='bx bx-cog'></i><span class="hidden sm:inline">Config</span>
          </button>
          <button id="reportsBtn" class="btn bg-stone-600 hover:bg-stone-700 text-white px-3 py-2 sm:px-4 flex items-center gap-2">
            <i class='bx bxs-report'></i><span class="hidden sm:inline">Relatórios</span>
          </button>
          <button id="addAtendimentoBtn" class="btn bg-amber-800 hover:bg-amber-900 text-white px-3 py-2 sm:px-4 flex items-center gap-2">
            <i class='bx bx-plus-circle'></i><span class="hidden sm:inline">Nova Ficha</span>
          </button>
          <div class="text-right">
            <p id="currentUserName" class="font-semibold text-gray-700"></p>
            <button id="logoutButton" class="text-sm text-red-500 hover:text-red-700">Sair</button>
          </div>
        </div>
      </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow">
      <div class="kanban-container" id="kanbanBoard"></div>
    </main>

    <footer class="bg-white shadow-top mt-8 py-4">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p><strong>Endereço:</strong> R. São Paulo, 856 - Jd. America, São José do Rio Preto - SP</p>
            <p><strong>Telefone:</strong> (17) 98155-3982 | <strong>Horário:</strong> Terça a Sábado, das 10h às 19h</p>
        </div>
    </footer>
  </div>

  <!-- MODAL PARA AGENDAR (NOVA FICHA) -->
  <div id="atendimentoModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="modal-content w-full max-w-xl">
      <div class="modal-header flex justify-between items-center">
        <h2 id="atendimentoModalTitle" class="text-2xl font-bold text-gray-800">Agendar Novo Atendimento</h2>
      </div>
      <div class="modal-body">
        <form id="atendimentoForm" class="space-y-4">
          <input type="hidden" id="atendimentoId">
          <div class="form-group">
            <label for="clienteNome" class="block text-sm font-medium">Nome do Cliente</label>
            <input id="clienteNome" type="text" placeholder="Nome completo" required class="p-2 border rounded w-full">
          </div>
          <div class="grid grid-cols-2 gap-4">
              <div class="form-group">
                  <label for="agendamentoData" class="block text-sm font-medium">Data</label>
                  <input id="agendamentoData" type="date" required class="p-2 border rounded w-full">
              </div>
              <div class="form-group">
                  <label for="agendamentoHora" class="block text-sm font-medium">Hora</label>
                  <input id="agendamentoHora" type="time" required class="p-2 border rounded w-full">
              </div>
          </div>
          <div class="form-group">
            <label for="barbeiroResponsavel" class="block text-sm font-medium">Barbeiro</label>
            <select id="barbeiroResponsavel" required class="p-2 border rounded w-full">
              <option value="João">Barbeiro João</option>
              <option value="Maria">Barbeira Maria</option>
            </select>
          </div>
          <div class="form-group">
            <label class="block text-sm font-medium">Serviços Agendados</label>
            <div id="servicosList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 p-2 border rounded-md bg-gray-50 max-h-40 overflow-y-auto"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-close-modal btn bg-gray-200 hover:bg-gray-300 text-gray-800">Cancelar</button>
        <button type="submit" form="atendimentoForm" class="btn bg-amber-800 hover:bg-amber-900 text-white">Salvar Agendamento</button>
      </div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>

  <!-- Script Inline -->
  <script>
    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBW6CaxaYTHbOpCRDCptaYbpFi8OHabMik",
        authDomain: "habibi-ba516.firebaseapp.com",
        databaseURL: "https://habibi-ba516-default-rtdb.firebaseio.com",
        projectId: "habibi-ba516",
        storageBucket: "habibi-ba516.appspot.com",
        messagingSenderId: "744908900549",
        appId: "1:744908900549:web:f61575c692913fae3a08ac"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Função para salvar agendamento no Firebase
    function saveAppointment(appointment) {
        const appointmentsRef = ref(database, 'appointments');
        set(appointmentsRef, appointment)
            .then(() => console.log('Agendamento salvo com sucesso'))
            .catch((error) => console.error('Erro ao salvar agendamento:', error));
    }

    // Função para buscar agendamentos do Firebase
    function fetchAppointments() {
        const appointmentsRef = ref(database, 'appointments');
        onValue(appointmentsRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                renderAppointments(data);
            }
        });
    }

    // Renderiza os agendamentos na tela
    function renderAppointments(appointments) {
        const kanbanBoard = document.getElementById('kanbanBoard');
        kanbanBoard.innerHTML = ''; // Limpa o conteúdo anterior

        const statuses = ['Aguardando', 'Em Atendimento', 'Aguardando Pagamento', 'Finalizado'];
        statuses.forEach(status => {
            const column = document.createElement('div');
            column.className = 'status-column';
            column.innerHTML = `
                <h3 class="text-lg font-bold p-2">${status}</h3>
                <div class="client-list"></div>
            `;
            kanbanBoard.appendChild(column);

            const clientList = column.querySelector('.client-list');
            Object.values(appointments).forEach(appointment => {
                if (appointment.status === status) {
                    const card = document.createElement('div');
                    card.className = `vehicle-card status-${status.replace(' ', '-')}`;
                    card.innerHTML = `
                        <p><strong>Cliente:</strong> ${appointment.clientName}</p>
                        <p><strong>Data/Hora:</strong> ${appointment.date} ${appointment.time}</p>
                    `;
                    clientList.appendChild(card);
                }
            });
        });
    }

    // Função para carregar a tela principal com base no usuário selecionado
    function loadDashboard(role) {
        document.getElementById('userScreen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('currentUserName').textContent = `Usuário: ${role}`;
        fetchAppointments(); // Carrega os agendamentos ao abrir o dashboard
    }

    // Exemplo de usuários (substitua por dados reais do Firebase ou backend)
    const users = [
        { name: 'Administrador', role: 'admin' },
        { name: 'Barbeiro João', role: 'barber' },
        { name: 'Recepcionista Maria', role: 'receptionist' }
    ];

    // Gerar botões de usuário dinamicamente
    document.addEventListener('DOMContentLoaded', () => {
        const userList = document.getElementById('userList');

        users.forEach(user => {
            const btn = document.createElement('button');
            btn.className = 'user-btn w-full text-center';
            btn.textContent = user.name;
            btn.onclick = () => loadDashboard(user.role); // Chama a função ao clicar
            userList.appendChild(btn);
        });

        // Abre o modal de agendamento
        document.getElementById('addAtendimentoBtn').addEventListener('click', () => {
            const modal = document.getElementById('atendimentoModal');
            modal.classList.remove('hidden');
        });

        // Fecha o modal
        document.querySelectorAll('.btn-close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                const modal = btn.closest('.modal');
                modal.classList.add('hidden');
            });
        });

        // Salva o agendamento
        document.getElementById('atendimentoForm').addEventListener('submit', event => {
            event.preventDefault();
            const form = event.target;
            const appointment = {
                clientName: form.clienteNome.value,
                date: form.agendamentoData.value,
                time: form.agendamentoHora.value,
                barber: form.barbeiroResponsavel.value,
                services: Array.from(form.servicosList.children).map(item => item.textContent),
                status: 'Aguardando'
            };
            saveAppointment(appointment);
            form.reset();
            document.getElementById('atendimentoModal').classList.add('hidden');
        });

        // Calculadora de Desconto
        document.getElementById('detailsDesconto').addEventListener('input', (e) => {
            const discountValue = parseFloat(e.target.value) || 0;
            const appointmentId = document.getElementById('detailsAtendimentoId').value;
            const appointment = getAppointmentsFromDatabase()[appointmentId]; // Substitua pela função real
            if (appointment) {
                const originalPrice = calculateOriginalPrice(appointment.services);
                const finalPrice = Math.max(originalPrice - discountValue, 0);
                updateUIWithDiscount(finalPrice);
            }
        });

        function calculateOriginalPrice(services) {
            return services.reduce((total, service) => total + getServicePrice(service), 0);
        }

        function getServicePrice(serviceName) {
            const servicePrices = {
                'Corte de Cabelo': 50,
                'Barba': 30,
                'Penteado': 40
            };
            return servicePrices[serviceName] || 0;
        }

        function updateUIWithDiscount(finalPrice) {
            document.getElementById('detailsValorFinal').textContent = `R$ ${finalPrice.toFixed(2)}`;
        }

        // Notificações
        function showNotification(message, type = 'success') {
            const existing = document.getElementById('notification');
            if (existing) existing.remove();
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => { if (document.body.contains(notification)) notification.remove(); }, 300);
            }, 3000);
        }

        // Botão de logout
        document.getElementById('logoutButton').addEventListener('click', () => {
            document.getElementById('userScreen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            document.getElementById('currentUserName').textContent = '';
        });
    });

    // Função para mostrar notificações
    function getAppointmentsFromDatabase() {
        // Simula recuperação de dados do Firebase
        return {
            1: { clientName: 'João Silva', date: '2023-10-10', time: '10:00', barber: 'João', services: ['Corte de Cabelo'], status: 'Aguardando' },
            2: { clientName: 'Maria Santos', date: '2023-10-10', time: '11:00', barber: 'Maria', services: ['Barba'], status: 'Em Atendimento' }
        };
    }
  </script>
</body>
</html>